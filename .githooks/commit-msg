#!/bin/sh
#
# Commit message hook: enforces Conventional Commits format.
#
# Valid format: type(optional-scope): description
# Types: feat, fix, docs, chore, refactor, test, style, perf, ci, build, revert
#
# Examples:
#   feat: add bid notifications
#   fix(auth): handle expired confirmation codes
#   docs: update integration guide
#   chore: bump dependencies
#
# Install: composer setup-hooks

commit_msg_file="$1"
commit_msg=$(head -1 "$commit_msg_file")

# Allow merge commits
if echo "$commit_msg" | grep -qE '^Merge '; then
    exit 0
fi

# Allow Dependabot commits
if echo "$commit_msg" | grep -qE '^Bump '; then
    exit 0
fi

# Allow revert commits generated by git
if echo "$commit_msg" | grep -qE '^Revert "'; then
    exit 0
fi

# Validate conventional commit format
# type(optional-scope): description
if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|chore|refactor|test|style|perf|ci|build|revert)(\(.+\))?: .+'; then
    echo ""
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "  Expected: type(scope): description"
    echo ""
    echo "  Types: feat, fix, docs, chore, refactor, test, style, perf, ci, build, revert"
    echo ""
    echo "  Examples:"
    echo "    feat: add email notifications for outbid users"
    echo "    fix(auth): handle expired confirmation codes"
    echo "    docs: update admin guide with new settings"
    echo "    chore: bump PHPUnit to v12"
    echo ""
    echo "  Your message: $commit_msg"
    echo ""
    exit 1
fi
